apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "clusterapp.releasename" . }}
  labels:
    {{- include "clusterapp.labels" . | nindent 4 }}
  spec:
    replicas: {{ .Values.replicaCount }}
    selector:
      matchLabels:
        {{- include "clusterapp.selectorLabels" . | nindent 6 }}
    template:
      metadata:
        labels:
          {{- include "clusterapp.selectorLabels" . | nindent 8 }}
      spec:
        containers:
          - name: service
            image: {{ .Values.appContainer.image | quote }}
            imagePullPolicy: IfNotPresent
            resources:
              {{- toYaml .Values.appContainer.resources | nindent 12 }}
            volumeMounts:
              - mountPath: /app
                name: runtime
              - mountPath: /scratch
                name: scratch
            envFrom:
              - configMapRef:
                  name: {{ include "clusterapp.envConfigMap" . }}
              {{- range .Values.appContainer.envMaps }}
              - configMapRef:
                  name: {{ . }}
              {{- end }}
            command: {{ .Values.appContainer.command }}
            args: {{ .Values.appContainer.args }}
          - name: envoy
            image: {{ .Values.envoy.image | quote }}
            imagePullPolicy: IfNotPresent
            resources:
              {{- toYaml .Values.envoy.resources | nindent 12 }}
            volumeMounts:
              - mountPath: /scratch
              name: scratch
              - mountPath: /config
              name: config
            command: ["sh"]
            args: ["/config/envoyBootstrap"]
          - name: jaeger-agent
            image: {{ .Values.jaeger.image | quote }}
            imagePullPolicy: IfNotPresent
            resources:
              {{- toYaml .Values.envoy.resources | nindent 12 }}
            ports:
              - containerPort: 5775
                protocol: UDP
              - containerPort: 5778
                protocol: TCP
              - containerPort: 6831
                protocol: UDP
              - containerPort: 6832
                protocol: UDP
            command:
              - "/go/bin/agent-linux"
              - "--collector.host-port={{ .Values.jaeger.collector }}"
        volumes:
          - name: runtime
            {{- if eq .Values.appVolume.type "manual" }}
            {{- toYaml .Values.appVolume.manualConfig | nindent 10 }}
            {{- end }}
          - name: scratch
            emptyDir: {}
          - name: config
            configMap:
              name: {{ include "clusterapp.volumeConfigMap" . }}
        {{- with .Values.nodeSelector }}
        nodeSelector:
          {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- with .Values.affinity }}
        affinity:
          {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
        tolerations:
          {{- toYaml . | nindent 8 }}
      {{- end }}
